"""\nMODULE 3 â€” API Health Monitor\nUsage:\n    from core.api_monitor import check_all_apis, check_single_api\n    results = check_all_apis()\n"""\nimport sys\nfrom pathlib import Path\nsys.path.insert(0, str(Path(__file__).resolve().parent.parent))\n\nimport time\nimport requests\nfrom datetime import datetime\nfrom core.models import SessionLocal, ApiHealthCheck\nfrom core.config import GEMINI_API_KEY, SERPAPI_KEY, SCRAPINGBEE_API_KEY\n\nAPI_TEST_ENDPOINTS = {\n    "gemini": {"url": "https://generativelanguage.googleapis.com/v1/models", "method": "GET", "params_fn": lambda: {"key": GEMINI_API_KEY}, "key": GEMINI_API_KEY},\n    "serpapi": {"url": "https://serpapi.com/account.json", "method": "GET", "params_fn": lambda: {"api_key": SERPAPI_KEY}, "key": SERPAPI_KEY},\n    "scrapingbee": {"url": "https://app.scrapingbee.com/api/v1/usage", "method": "GET", "params_fn": lambda: {"api_key": SCRAPINGBEE_API_KEY}, "key": SCRAPINGBEE_API_KEY},\n}\n\ndef _ping_service(service_name: str) -> dict:\n    config = API_TEST_ENDPOINTS.get(service_name)\n    if not config:\n        return {"status": "UNKNOWN", "latency_ms": None, "error": f"Service '{service_name}' not configured."}\n    if not config["key"]:\n        return {"status": "OFFLINE", "latency_ms": None, "error": "API key not configured in .env"}\n    try:\n        start = time.time()\n        resp = requests.get(config["url"], params=config["params_fn"](), timeout=10)\n        latency_ms = int((time.time() - start) * 1000)\n        if resp.status_code < 400:\n            return {"status": "ONLINE", "latency_ms": latency_ms, "error": None}\n        elif resp.status_code < 500:\n            return {"status": "DEGRADED", "latency_ms": latency_ms, "error": f"HTTP {resp.status_code}"}\n        else:\n            return {"status": "OFFLINE", "latency_ms": latency_ms, "error": f"HTTP {resp.status_code}"}\n    except requests.exceptions.Timeout:\n        return {"status": "OFFLINE", "latency_ms": None, "error": "Timeout (>10s)"}\n    except Exception as e:\n        return {"status": "OFFLINE", "latency_ms": None, "error": str(e)[:200]}\n\ndef check_single_api(service_name: str) -> dict:\n    result = _ping_service(service_name)\n    db = SessionLocal()\n    try:\n        health = db.query(ApiHealthCheck).filter(ApiHealthCheck.service_name == service_name).first()\n        if not health:\n            health = ApiHealthCheck(service_name=service_name)\n            db.add(health)\n        health.status = result["status"]\n        health.last_check_at = datetime.utcnow()\n        health.last_response_ms = result["latency_ms"]\n        health.error_message = result["error"]\n        if result["status"] == "OFFLINE":\n            health.consecutive_failures = (health.consecutive_failures or 0) + 1\n        else:\n            health.consecutive_failures = 0\n        db.commit()\n    except Exception as e:\n        db.rollback()\n        result["db_error"] = str(e)\n    finally:\n        db.close()\n    return result\n\ndef check_all_apis() -> dict:\n    results = {}\n    for service_name in API_TEST_ENDPOINTS:\n        results[service_name] = check_single_api(service_name)\n    return results\n