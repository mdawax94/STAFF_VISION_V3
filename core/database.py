"""\nMODULE 5 â€” Multi-Tenant Database Router\nUsage:\n    from core.database import get_tenant_session, get_default_session\n    session = get_tenant_session(tenant_id=3)\n    session = get_default_session()\n"""\nimport sys\nfrom pathlib import Path\nsys.path.insert(0, str(Path(__file__).resolve().parent.parent))\n\nfrom sqlalchemy import create_engine\nfrom sqlalchemy.orm import sessionmaker, Session\nfrom core.config import DATABASE_URL\nfrom core.models import SessionLocal, DbTenant\n\n_tenant_engines = {}\n\n\ndef get_default_session() -> Session:\n    return SessionLocal()\n\n\ndef get_tenant_session(tenant_id: int) -> Session:\n    if tenant_id in _tenant_engines:\n        factory = sessionmaker(autocommit=False, autoflush=False, bind=_tenant_engines[tenant_id])\n        return factory()\n    main_db = SessionLocal()\n    try:\n        tenant = main_db.query(DbTenant).filter(DbTenant.id == tenant_id, DbTenant.is_active == True).first()\n        if not tenant:\n            raise ValueError(f"Tenant ID {tenant_id} not found or inactive.")\n        conn_string = tenant.connection_string\n    finally:\n        main_db.close()\n    engine = create_engine(conn_string, echo=False, pool_pre_ping=True)\n    _tenant_engines[tenant_id] = engine\n    factory = sessionmaker(autocommit=False, autoflush=False, bind=engine)\n    return factory()\n\n\ndef get_session_for_agent(agent_config_id: int) -> Session:\n    from core.models import AgentConfig\n    main_db = SessionLocal()\n    try:\n        agent = main_db.query(AgentConfig).filter(AgentConfig.id == agent_config_id).first()\n        if not agent:\n            raise ValueError(f"AgentConfig ID {agent_config_id} not found.")\n        tenant_id = agent.tenant_id\n    finally:\n        main_db.close()\n    if tenant_id:\n        return get_tenant_session(tenant_id)\n    else:\n        return get_default_session()\n